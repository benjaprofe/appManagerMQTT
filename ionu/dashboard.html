<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema IONU Monitoreo Institucional</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f4c75 0%, #3282b8 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }
        .status {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 18px;
        }
        .status.connected {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4caf50;
        }
        .status.disconnected {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .section h2 {
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }
        .sensor-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4caf50;
            transition: all 0.3s;
        }
        .sensor-card:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.15);
        }
        .sensor-card.warning {
            border-left-color: #ff9800;
        }
        .sensor-card.danger {
            border-left-color: #f44336;
            animation: blink 1s infinite;
        }
        .sensor-card.info {
            border-left-color: #2196F3;
        }
        .sensor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .sensor-name {
            font-weight: bold;
            font-size: 1.1em;
        }
        .sensor-value {
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        .sensor-status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .status-on {
            background: #4caf50;
            color: white;
        }
        .status-off {
            background: #666;
            color: white;
        }
        .status-active {
            background: #2196F3;
            color: white;
        }
        .status-inactive {
            background: #f44336;
            color: white;
        }
        .status-open {
            background: #4caf50;
            color: white;
        }
        .status-close {
            background: #f44336;
            color: white;
        }
        .status-normal {
            background: #4caf50;
            color: white;
        }
        .status-alert {
            background: #ff9800;
            color: white;
        }
        .status-critical {
            background: #f44336;
            color: white;
        }
        .pet-message {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-style: italic;
            font-size: 0.9em;
        }
        .plant-risk {
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
            display: inline-block;
        }
        .risk-low {
            background: #4caf50;
            color: white;
        }
        .risk-medium {
            background: #ff9800;
            color: white;
        }
        .risk-high {
            background: #f44336;
            color: white;
        }
        .logs-container {
            grid-column: 1 / -1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .logs-container h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .log-entry {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #4caf50;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .log-entry.error {
            border-left-color: #f44336;
        }
        .log-entry.warning {
            border-left-color: #ff9800;
        }
        .log-entry.success {
            border-left-color: #4caf50;
        }
        .timestamp {
            color: #aaa;
            font-size: 0.8em;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .camera-preview {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: #aaa;
        }
        .camera-preview.active {
            border: 2px solid #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¢ Dashboard IONU - Monitoreo Institucional</h1>
        <div id="status" class="status disconnected">Desconectado</div>
        
        <div class="dashboard-grid">
            <!-- SECCI√ìN SEGURIDAD -->
            <div class="section">
                <h2>üîí Seguridad</h2>
                
                <!-- C√°maras -->
                <div class="sensor-card" id="camera1">
                    <div class="sensor-header">
                        <span class="sensor-name">üìπ C√°mara Principal</span>
                        <span class="sensor-status status-off" id="camera1-status">OFF</span>
                    </div>
                    <div class="camera-preview" id="camera1-preview">C√°mara desactivada</div>
                </div>

                <div class="sensor-card" id="camera2">
                    <div class="sensor-header">
                        <span class="sensor-name">üìπ C√°mara Secundaria</span>
                        <span class="sensor-status status-off" id="camera2-status">OFF</span>
                    </div>
                    <div class="camera-preview" id="camera2-preview">C√°mara desactivada</div>
                </div>

                <!-- Sensor de Movimiento -->
                <div class="sensor-card" id="movement">
                    <div class="sensor-header">
                        <span class="sensor-name">üë§ Sensor de Movimiento</span>
                        <span class="sensor-status status-normal" id="movement-status">Normal</span>
                    </div>
                    <div class="sensor-value" id="movement-value">Sin movimiento</div>
                </div>

                <!-- Sensores de Puertas -->
                <div class="sensor-card" id="door1">
                    <div class="sensor-header">
                        <span class="sensor-name">üö™ Puerta Principal</span>
                        <span class="sensor-status status-close" id="door1-status">Cerrada</span>
                    </div>
                </div>

                <div class="sensor-card" id="door2">
                    <div class="sensor-header">
                        <span class="sensor-name">üö™ Puerta Secundaria</span>
                        <span class="sensor-status status-close" id="door2-status">Cerrada</span>
                    </div>
                </div>

                <!-- Alarma -->
                <div class="sensor-card" id="alarm">
                    <div class="sensor-header">
                        <span class="sensor-name">üö® Sistema de Alarma</span>
                        <span class="sensor-status status-inactive" id="alarm-status">Desactivada</span>
                    </div>
                </div>

                <!-- Control de Accesos -->
                <div class="sensor-card" id="access">
                    <div class="sensor-header">
                        <span class="sensor-name">üîë Control de Accesos</span>
                        <span class="sensor-status status-active" id="access-status">Activo</span>
                    </div>
                    <div class="sensor-value" id="access-value">√öltimo acceso: --</div>
                </div>
            </div>

            <!-- SECCI√ìN AMBIENTE -->
            <div class="section">
                <h2>üå°Ô∏è Ambiente</h2>
                
                <!-- Temperatura -->
                <div class="sensor-card" id="temperature">
                    <div class="sensor-header">
                        <span class="sensor-name">üå°Ô∏è Temperatura</span>
                        <span class="sensor-status status-normal" id="temperature-status">Normal</span>
                    </div>
                    <div class="sensor-value" id="temperature-value">22¬∞C</div>
                </div>

                <!-- Humedad -->
                <div class="sensor-card" id="humidity">
                    <div class="sensor-header">
                        <span class="sensor-name">üíß Humedad</span>
                        <span class="sensor-status status-normal" id="humidity-status">Normal</span>
                    </div>
                    <div class="sensor-value" id="humidity-value">45%</div>
                </div>

                <!-- Riego Autom√°tico -->
                <div class="sensor-card" id="irrigation">
                    <div class="sensor-header">
                        <span class="sensor-name">üíß Sistema de Riego</span>
                        <span class="sensor-status status-off" id="irrigation-status">Desactivado</span>
                    </div>
                    <div class="sensor-value" id="irrigation-value">√öltimo riego: --</div>
                </div>

                <!-- Riesgo de Plantas -->
                <div class="sensor-card" id="plants">
                    <div class="sensor-header">
                        <span class="sensor-name">üå± Estado de Plantas</span>
                    </div>
                    <div class="sensor-value" id="plants-value">Monitoreando...</div>
                    <div class="plant-risk risk-low" id="plants-risk">Riesgo: Bajo</div>
                </div>
            </div>

            <!-- SECCI√ìN MASCOTAS -->
            <div class="section">
                <h2>üêæ Sector de Mascotas</h2>
                
                <!-- Temperatura Mascotas -->
                <div class="sensor-card" id="pet-temperature">
                    <div class="sensor-header">
                        <span class="sensor-name">üå°Ô∏è Temperatura Ambiente</span>
                        <span class="sensor-status status-normal" id="pet-temperature-status">Normal</span>
                    </div>
                    <div class="sensor-value" id="pet-temperature-value">24¬∞C</div>
                </div>

                <!-- Ventiladores -->
                <div class="sensor-card" id="pet-fans">
                    <div class="sensor-header">
                        <span class="sensor-name">üåÄ Ventiladores</span>
                        <span class="sensor-status status-off" id="pet-fans-status">Apagados</span>
                    </div>
                    <div class="sensor-value" id="pet-fans-value">Velocidad: 0%</div>
                </div>

                <!-- Estado General -->
                <div class="sensor-card" id="pet-status">
                    <div class="sensor-header">
                        <span class="sensor-name">üìä Estado General</span>
                        <span class="sensor-status status-normal" id="pet-status-status">Normal</span>
                    </div>
                    <div class="sensor-value" id="pet-status-value">Todo en orden</div>
                </div>

                <!-- Comida -->
                <div class="sensor-card" id="pet-food">
                    <div class="sensor-header">
                        <span class="sensor-name">üçΩÔ∏è Dispensador de Comida</span>
                        <span class="sensor-status status-off" id="pet-food-status">Listo</span>
                    </div>
                    <div class="sensor-value" id="pet-food-value">√öltima comida: --</div>
                </div>

                <!-- Agua -->
                <div class="sensor-card" id="pet-water">
                    <div class="sensor-header">
                        <span class="sensor-name">üíß Dispensador de Agua</span>
                        <span class="sensor-status status-active" id="pet-water-status">Activo</span>
                    </div>
                    <div class="sensor-value" id="pet-water-value">Nivel: Normal</div>
                </div>

                <!-- Luz -->
                <div class="sensor-card" id="pet-light">
                    <div class="sensor-header">
                        <span class="sensor-name">üí° Iluminaci√≥n</span>
                        <span class="sensor-status status-on" id="pet-light-status">Encendida</span>
                    </div>
                    <div class="sensor-value" id="pet-light-value">Intensidad: 80%</div>
                </div>

                <!-- Mensajes -->
                <div class="sensor-card" id="pet-messages">
                    <div class="sensor-header">
                        <span class="sensor-name">üí¨ Mensajes</span>
                    </div>
                    <div class="pet-message" id="pet-message-text">No hay mensajes nuevos</div>
                </div>
            </div>
        </div>

        <!-- Logs -->
        <div class="logs-container">
            <h3>üìù Logs de Eventos en Tiempo Real</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script src="../env/credential.js"></script>
    <script>
        const client = createMqttClient('client_ionu');

        const estados = {
            // Seguridad
            camera1: 'off',
            camera2: 'off',
            movement: 'normal',
            door1: 'close',
            door2: 'close',
            alarm: 'disabled',
            access: 'active',
            lastAccess: '--',
            // Ambiente
            temperature: 22,
            humidity: 45,
            irrigation: 'off',
            lastIrrigation: '--',
            plantsRisk: 'low',
            // Mascotas
            petTemperature: 24,
            petFans: 'off',
            petFansSpeed: 0,
            petStatus: 'normal',
            petFood: 'ready',
            lastFood: '--',
            petWater: 'active',
            waterLevel: 'normal',
            petLight: 'on',
            lightIntensity: 80,
            petMessage: 'No hay mensajes nuevos'
        };

        client.on("connect", () => {
            console.log("Dashboard IONU conectado!");
            document.getElementById("status").textContent = "‚úÖ Conectado";
            document.getElementById("status").className = "status connected";
            
            const topics = [
                // Seguridad
                "ionu/seguridad/camara1/state",
                "ionu/seguridad/camara2/state",
                "ionu/seguridad/movimiento",
                "ionu/seguridad/puerta1/state",
                "ionu/seguridad/puerta2/state",
                "ionu/seguridad/alarma/state",
                "ionu/seguridad/acceso",
                // Ambiente
                "ionu/ambiente/temperatura",
                "ionu/ambiente/humedad",
                "ionu/ambiente/riego/state",
                "ionu/ambiente/plantas/riesgo",
                // Mascotas
                "ionu/mascotas/temperatura",
                "ionu/mascotas/ventiladores/state",
                "ionu/mascotas/estado",
                "ionu/mascotas/comida/state",
                "ionu/mascotas/agua/state",
                "ionu/mascotas/luz/state",
                "ionu/mascotas/mensajes"
            ];
            
            topics.forEach((topic, index) => {
                setTimeout(() => {
                    client.subscribe(topic, { qos: 1 }, (err, granted) => {
                        if (err) {
                            console.error(`‚ùå Error suscribi√©ndose a ${topic}:`, err);
                            addLog(`‚ùå Error: ${topic}`, "error");
                        } else {
                            console.log(`‚úÖ Suscrito a: ${topic}`);
                            addLog(`‚úÖ Suscrito: ${topic}`, "success");
                        }
                    });
                }, index * 100);
            });
            
            setTimeout(() => {
                client.subscribe("ionu/#", { qos: 1 }, (err) => {
                    if (!err) {
                        console.log("‚úÖ Suscrito a wildcard: ionu/#");
                        addLog("‚úÖ Wildcard: ionu/#", "success");
                    }
                });
            }, topics.length * 100 + 200);
        });

        client.on("error", (error) => {
            console.error("Error:", error);
            document.getElementById("status").textContent = "‚ùå Error de conexi√≥n";
            document.getElementById("status").className = "status disconnected";
            addLog("Error de conexi√≥n: " + error, "error");
        });

        client.on("offline", () => {
            console.log("Cliente desconectado");
            document.getElementById("status").textContent = "‚ùå Desconectado";
            document.getElementById("status").className = "status disconnected";
            addLog("‚ö†Ô∏è Desconectado de MQTT", "warning");
        });

        client.on("reconnect", () => {
            console.log("Reconectando...");
            document.getElementById("status").textContent = "üîÑ Reconectando...";
            addLog("üîÑ Intentando reconectar...", "warning");
        });

        client.on("message", (topic, message) => {
            const msg = message.toString();
            console.log(`üì® Mensaje recibido: ${topic} = ${msg}`);
            
            try {
                updateSensor(topic, msg);
                addLog(`${topic}: ${msg}`, "info");
            } catch (error) {
                console.error(`‚ùå Error procesando mensaje de ${topic}:`, error);
                addLog(`‚ùå Error procesando ${topic}: ${error.message}`, "error");
            }
        });

        function updateSensor(topic, value) {
            console.log(`üîÑ Actualizando sensor: ${topic} con valor: ${value}`);
            
            // Seguridad
            if (topic === "ionu/seguridad/camara1/state" || topic.includes("camara1")) {
                updateCamera('camera1', value);
            } else if (topic === "ionu/seguridad/camara2/state" || topic.includes("camara2")) {
                updateCamera('camera2', value);
            } else if (topic.includes("movimiento")) {
                updateMovement(value);
            } else if (topic === "ionu/seguridad/puerta1/state" || topic.includes("puerta1")) {
                updateDoor('door1', value);
            } else if (topic === "ionu/seguridad/puerta2/state" || topic.includes("puerta2")) {
                updateDoor('door2', value);
            } else if (topic.includes("alarma")) {
                updateAlarm(value);
            } else if (topic.includes("acceso")) {
                updateAccess(value);
            }
            // Ambiente
            else if (topic.includes("temperatura") && !topic.includes("mascotas")) {
                updateTemperature(value);
            } else if (topic.includes("humedad")) {
                updateHumidity(value);
            } else if (topic.includes("riego")) {
                updateIrrigation(value);
            } else if (topic.includes("plantas") || topic.includes("riesgo")) {
                updatePlantsRisk(value);
            }
            // Mascotas
            else if (topic.includes("mascotas/temperatura")) {
                updatePetTemperature(value);
            } else if (topic.includes("ventiladores")) {
                updatePetFans(value);
            } else if (topic.includes("mascotas/estado")) {
                updatePetStatus(value);
            } else if (topic.includes("comida")) {
                updatePetFood(value);
            } else if (topic.includes("agua") && topic.includes("mascotas")) {
                updatePetWater(value);
            } else if (topic.includes("luz") && topic.includes("mascotas")) {
                updatePetLight(value);
            } else if (topic.includes("mensajes")) {
                updatePetMessage(value);
            } else {
                console.log(`‚ÑπÔ∏è Topic no mapeado: ${topic} = ${value}`);
            }
        }

        function updateCamera(cameraId, state) {
            const statusEl = document.getElementById(`${cameraId}-status`);
            const previewEl = document.getElementById(`${cameraId}-preview`);
            
            if (!statusEl || !previewEl) {
                console.error(`‚ùå Elementos no encontrados para ${cameraId}`);
                return;
            }
            
            const stateLower = String(state).toLowerCase().trim();
            console.log(`üìπ Actualizando ${cameraId}: ${stateLower}`);
            
            if (stateLower === 'on' || stateLower === 'active' || stateLower === '1' || stateLower === 'true') {
                statusEl.textContent = 'ON';
                statusEl.className = 'sensor-status status-on';
                previewEl.textContent = 'üìπ C√°mara activa - Transmitiendo';
                previewEl.classList.add('active');
                console.log(`‚úÖ ${cameraId} activada`);
            } else {
                statusEl.textContent = 'OFF';
                statusEl.className = 'sensor-status status-off';
                previewEl.textContent = 'C√°mara desactivada';
                previewEl.classList.remove('active');
                console.log(`‚úÖ ${cameraId} desactivada`);
            }
        }

        function updateMovement(value) {
            const statusEl = document.getElementById('movement-status');
            const valueEl = document.getElementById('movement-value');
            const card = document.getElementById('movement');
            
            if (!statusEl || !valueEl || !card) {
                console.error('‚ùå Elementos no encontrados para movimiento');
                return;
            }
            
            const valueLower = String(value).toLowerCase().trim();
            console.log(`üë§ Actualizando movimiento: ${valueLower}`);
            
            if (valueLower === 'detected' || valueLower === 'si' || valueLower === 'yes' || valueLower === '1' || valueLower === 'true' || valueLower === 'movimiento') {
                statusEl.textContent = 'Movimiento Detectado';
                statusEl.className = 'sensor-status status-alert';
                valueEl.textContent = '‚ö†Ô∏è Movimiento detectado';
                card.classList.add('danger');
                addLog('üö® Movimiento detectado en el √°rea', 'warning');
                console.log('‚úÖ Movimiento detectado');
            } else {
                statusEl.textContent = 'Normal';
                statusEl.className = 'sensor-status status-normal';
                valueEl.textContent = 'Sin movimiento';
                card.classList.remove('danger');
                console.log('‚úÖ Sin movimiento');
            }
        }

        function updateDoor(doorId, state) {
            const statusEl = document.getElementById(`${doorId}-status`);
            
            if (!statusEl) {
                console.error(`‚ùå Elemento no encontrado para ${doorId}`);
                return;
            }
            
            const stateLower = String(state).toLowerCase().trim();
            console.log(`üö™ Actualizando ${doorId}: ${stateLower}`);
            
            if (stateLower === 'open' || stateLower === 'abierta' || stateLower === '1' || stateLower === 'true') {
                statusEl.textContent = 'Abierta';
                statusEl.className = 'sensor-status status-open';
                console.log(`‚úÖ ${doorId} abierta`);
            } else {
                statusEl.textContent = 'Cerrada';
                statusEl.className = 'sensor-status status-close';
                console.log(`‚úÖ ${doorId} cerrada`);
            }
        }

        function updateAlarm(state) {
            const statusEl = document.getElementById('alarm-status');
            const card = document.getElementById('alarm');
            
            if (!statusEl || !card) {
                console.error('‚ùå Elementos no encontrados para alarma');
                return;
            }
            
            const stateLower = String(state).toLowerCase().trim();
            console.log(`üö® Actualizando alarma: ${stateLower}`);
            
            if (stateLower === 'enabled' || stateLower === 'activada' || stateLower === 'on' || stateLower === '1' || stateLower === 'true') {
                statusEl.textContent = 'Activada';
                statusEl.className = 'sensor-status status-active';
                card.classList.add('danger');
                console.log('‚úÖ Alarma activada');
            } else {
                statusEl.textContent = 'Desactivada';
                statusEl.className = 'sensor-status status-inactive';
                card.classList.remove('danger');
                console.log('‚úÖ Alarma desactivada');
            }
        }

        function updateAccess(value) {
            const valueEl = document.getElementById('access-value');
            
            if (!valueEl) {
                console.error('‚ùå Elemento no encontrado para acceso');
                return;
            }
            
            try {
                let accessData = value;
                if (typeof value === 'string' && value.startsWith('{')) {
                    accessData = JSON.parse(value);
                }
                
                const timestamp = accessData.timestamp ? new Date(accessData.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
                const user = accessData.user || 'Usuario';
                const type = accessData.type || 'acceso';
                
                estados.lastAccess = timestamp;
                valueEl.textContent = `√öltimo acceso: ${user} (${type}) - ${timestamp}`;
                console.log(`‚úÖ Acceso registrado: ${user} - ${type}`);
            } catch (error) {
                estados.lastAccess = new Date().toLocaleTimeString();
                valueEl.textContent = `√öltimo acceso: ${value} - ${estados.lastAccess}`;
                console.log(`‚úÖ Acceso registrado: ${value}`);
            }
        }

        function updateTemperature(value) {
            const statusEl = document.getElementById('temperature-status');
            const valueEl = document.getElementById('temperature-value');
            const card = document.getElementById('temperature');
            
            if (!statusEl || !valueEl || !card) {
                console.error('‚ùå Elementos no encontrados para temperatura');
                return;
            }
            
            const temp = parseFloat(value);
            if (isNaN(temp)) {
                console.error(`‚ùå Valor de temperatura inv√°lido: ${value}`);
                return;
            }
            
            console.log(`üå°Ô∏è Actualizando temperatura: ${temp}¬∞C`);
            valueEl.textContent = `${temp}¬∞C`;
            
            if (temp < 18 || temp > 26) {
                statusEl.textContent = 'Alerta';
                statusEl.className = 'sensor-status status-alert';
                card.classList.add('warning');
                console.log('‚ö†Ô∏è Temperatura fuera de rango');
            } else {
                statusEl.textContent = 'Normal';
                statusEl.className = 'sensor-status status-normal';
                card.classList.remove('warning');
                console.log('‚úÖ Temperatura normal');
            }
        }

        function updateHumidity(value) {
            const statusEl = document.getElementById('humidity-status');
            const valueEl = document.getElementById('humidity-value');
            
            if (!statusEl || !valueEl) {
                console.error('‚ùå Elementos no encontrados para humedad');
                return;
            }
            
            const hum = parseFloat(value);
            if (isNaN(hum)) {
                console.error(`‚ùå Valor de humedad inv√°lido: ${value}`);
                return;
            }
            
            console.log(`üíß Actualizando humedad: ${hum}%`);
            valueEl.textContent = `${hum}%`;
            
            if (hum < 30 || hum > 70) {
                statusEl.textContent = 'Alerta';
                statusEl.className = 'sensor-status status-alert';
                console.log('‚ö†Ô∏è Humedad fuera de rango');
            } else {
                statusEl.textContent = 'Normal';
                statusEl.className = 'sensor-status status-normal';
                console.log('‚úÖ Humedad normal');
            }
        }

        function updateIrrigation(state) {
            const statusEl = document.getElementById('irrigation-status');
            const valueEl = document.getElementById('irrigation-value');
            
            if (!statusEl || !valueEl) {
                console.error('‚ùå Elementos no encontrados para riego');
                return;
            }
            
            const stateLower = String(state).toLowerCase().trim();
            console.log(`üíß Actualizando riego: ${stateLower}`);
            
            if (stateLower === 'on' || stateLower === 'active' || stateLower === '1' || stateLower === 'true') {
                statusEl.textContent = 'Activado';
                statusEl.className = 'sensor-status status-on';
                estados.lastIrrigation = new Date().toLocaleTimeString();
                valueEl.textContent = `√öltimo riego: ${estados.lastIrrigation}`;
                console.log('‚úÖ Riego activado');
            } else {
                statusEl.textContent = 'Desactivado';
                statusEl.className = 'sensor-status status-off';
                console.log('‚úÖ Riego desactivado');
            }
        }

        function updatePlantsRisk(risk) {
            const valueEl = document.getElementById('plants-value');
            const riskEl = document.getElementById('plants-risk');
            
            if (!valueEl || !riskEl) {
                console.error('‚ùå Elementos no encontrados para plantas');
                return;
            }
            
            const riskLower = String(risk).toLowerCase().trim();
            console.log(`üå± Actualizando riesgo de plantas: ${riskLower}`);
            
            riskEl.className = `plant-risk risk-${riskLower}`;
            
            if (riskLower === 'low' || riskLower === 'bajo' || riskLower === '0') {
                riskEl.textContent = 'Riesgo: Bajo';
                valueEl.textContent = 'Plantas saludables';
                console.log('‚úÖ Riesgo bajo');
            } else if (riskLower === 'medium' || riskLower === 'medio' || riskLower === '1') {
                riskEl.textContent = 'Riesgo: Medio';
                valueEl.textContent = 'Atenci√≥n requerida';
                console.log('‚ö†Ô∏è Riesgo medio');
            } else {
                riskEl.textContent = 'Riesgo: Alto';
                valueEl.textContent = 'Acci√≥n inmediata necesaria';
                console.log('üö® Riesgo alto');
            }
        }

        function updatePetTemperature(value) {
            const statusEl = document.getElementById('pet-temperature-status');
            const valueEl = document.getElementById('pet-temperature-value');
            
            if (!statusEl || !valueEl) {
                console.error('‚ùå Elementos no encontrados para temperatura de mascotas');
                return;
            }
            
            const temp = parseFloat(value);
            if (isNaN(temp)) {
                console.error(`‚ùå Valor de temperatura inv√°lido: ${value}`);
                return;
            }
            
            console.log(`üå°Ô∏è Actualizando temperatura mascotas: ${temp}¬∞C`);
            valueEl.textContent = `${temp}¬∞C`;
            
            if (temp < 20 || temp > 28) {
                statusEl.textContent = 'Alerta';
                statusEl.className = 'sensor-status status-alert';
                console.log('‚ö†Ô∏è Temperatura fuera de rango');
            } else {
                statusEl.textContent = 'Normal';
                statusEl.className = 'sensor-status status-normal';
                console.log('‚úÖ Temperatura normal');
            }
        }

        function updatePetFans(value) {
            const statusEl = document.getElementById('pet-fans-status');
            const valueEl = document.getElementById('pet-fans-value');
            
            if (!statusEl || !valueEl) {
                console.error('‚ùå Elementos no encontrados para ventiladores');
                return;
            }
            
            try {
                let data = {};
                if (typeof value === 'string' && (value.startsWith('{') || value.includes('state'))) {
                    data = JSON.parse(value);
                } else {
                    const stateLower = String(value).toLowerCase().trim();
                    data = { state: stateLower };
                }
                
                const stateLower = String(data.state || value).toLowerCase().trim();
                console.log(`üåÄ Actualizando ventiladores: ${stateLower}`);
                
                if (stateLower === 'on' || stateLower === 'active' || stateLower === '1' || stateLower === 'true') {
                    statusEl.textContent = 'Encendidos';
                    statusEl.className = 'sensor-status status-on';
                    valueEl.textContent = `Velocidad: ${data.speed || 50}%`;
                    console.log(`‚úÖ Ventiladores encendidos a ${data.speed || 50}%`);
                } else {
                    statusEl.textContent = 'Apagados';
                    statusEl.className = 'sensor-status status-off';
                    valueEl.textContent = 'Velocidad: 0%';
                    console.log('‚úÖ Ventiladores apagados');
                }
            } catch (error) {
                console.error('‚ùå Error parseando datos de ventiladores:', error);
                const stateLower = String(value).toLowerCase().trim();
                if (stateLower === 'on' || stateLower === '1') {
                    statusEl.textContent = 'Encendidos';
                    statusEl.className = 'sensor-status status-on';
                    valueEl.textContent = 'Velocidad: 50%';
                } else {
                    statusEl.textContent = 'Apagados';
                    statusEl.className = 'sensor-status status-off';
                    valueEl.textContent = 'Velocidad: 0%';
                }
            }
        }

        function updatePetStatus(value) {
            const statusEl = document.getElementById('pet-status-status');
            const valueEl = document.getElementById('pet-status-value');
            
            if (!statusEl || !valueEl) {
                console.error('‚ùå Elementos no encontrados para estado de mascotas');
                return;
            }
            
            const valueLower = String(value).toLowerCase().trim();
            console.log(`üìä Actualizando estado mascotas: ${valueLower}`);
            
            if (valueLower === 'normal' || valueLower === 'ok' || valueLower === '1') {
                statusEl.textContent = 'Normal';
                statusEl.className = 'sensor-status status-normal';
                valueEl.textContent = 'Todo en orden';
                console.log('‚úÖ Estado normal');
            } else {
                statusEl.textContent = 'Atenci√≥n';
                statusEl.className = 'sensor-status status-alert';
                valueEl.textContent = 'Revisar condiciones';
                console.log('‚ö†Ô∏è Estado requiere atenci√≥n');
            }
        }

        function updatePetFood(value) {
            const statusEl = document.getElementById('pet-food-status');
            const valueEl = document.getElementById('pet-food-value');
            
            if (!statusEl || !valueEl) {
                console.error('‚ùå Elementos no encontrados para comida');
                return;
            }
            
            const valueLower = String(value).toLowerCase().trim();
            console.log(`üçΩÔ∏è Actualizando comida: ${valueLower}`);
            
            if (valueLower === 'dispensed' || valueLower === 'dispensado' || valueLower === 'dispense' || valueLower === '1') {
                estados.lastFood = new Date().toLocaleTimeString();
                valueEl.textContent = `√öltima comida: ${estados.lastFood}`;
                statusEl.textContent = 'Dispensado';
                console.log('‚úÖ Comida dispensada');
            } else {
                statusEl.textContent = 'Listo';
                valueEl.textContent = '√öltima comida: --';
                console.log('‚úÖ Dispensador listo');
            }
        }

        function updatePetWater(value) {
            const statusEl = document.getElementById('pet-water-status');
            const valueEl = document.getElementById('pet-water-value');
            
            if (!statusEl || !valueEl) {
                console.error('‚ùå Elementos no encontrados para agua');
                return;
            }
            
            const valueLower = String(value).toLowerCase().trim();
            console.log(`üíß Actualizando agua: ${valueLower}`);
            
            if (valueLower === 'active' || valueLower === 'on' || valueLower === '1' || valueLower === 'true' || valueLower === 'normal') {
                statusEl.textContent = 'Activo';
                statusEl.className = 'sensor-status status-active';
                valueEl.textContent = 'Nivel: Normal';
                console.log('‚úÖ Agua activa');
            } else {
                statusEl.textContent = 'Inactivo';
                statusEl.className = 'sensor-status status-inactive';
                valueEl.textContent = 'Nivel: Bajo';
                console.log('‚ö†Ô∏è Agua inactiva');
            }
        }

        function updatePetLight(value) {
            const statusEl = document.getElementById('pet-light-status');
            const valueEl = document.getElementById('pet-light-value');
            
            if (!statusEl || !valueEl) {
                console.error('‚ùå Elementos no encontrados para luz');
                return;
            }
            
            try {
                let data = {};
                if (typeof value === 'string' && (value.startsWith('{') || value.includes('state'))) {
                    data = JSON.parse(value);
                } else {
                    const stateLower = String(value).toLowerCase().trim();
                    data = { state: stateLower };
                }
                
                const stateLower = String(data.state || value).toLowerCase().trim();
                console.log(`üí° Actualizando luz: ${stateLower}`);
                
                if (stateLower === 'on' || stateLower === 'active' || stateLower === '1' || stateLower === 'true') {
                    statusEl.textContent = 'Encendida';
                    statusEl.className = 'sensor-status status-on';
                    valueEl.textContent = `Intensidad: ${data.intensity || 80}%`;
                    console.log(`‚úÖ Luz encendida a ${data.intensity || 80}%`);
                } else {
                    statusEl.textContent = 'Apagada';
                    statusEl.className = 'sensor-status status-off';
                    valueEl.textContent = 'Intensidad: 0%';
                    console.log('‚úÖ Luz apagada');
                }
            } catch (error) {
                console.error('‚ùå Error parseando datos de luz:', error);
                const stateLower = String(value).toLowerCase().trim();
                if (stateLower === 'on' || stateLower === '1') {
                    statusEl.textContent = 'Encendida';
                    statusEl.className = 'sensor-status status-on';
                    valueEl.textContent = 'Intensidad: 80%';
                } else {
                    statusEl.textContent = 'Apagada';
                    statusEl.className = 'sensor-status status-off';
                    valueEl.textContent = 'Intensidad: 0%';
                }
            }
        }

        function updatePetMessage(value) {
            const messageEl = document.getElementById('pet-message-text');
            
            if (!messageEl) {
                console.error('‚ùå Elemento no encontrado para mensajes');
                return;
            }
            
            console.log(`üí¨ Actualizando mensaje: ${value}`);
            messageEl.textContent = value || 'No hay mensajes nuevos';
            console.log('‚úÖ Mensaje actualizado');
        }

        function addLog(message, type = 'info') {
            const logsContainer = document.getElementById("logs");
            const logEntry = document.createElement("div");
            logEntry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            
            logsContainer.insertBefore(logEntry, logsContainer.firstChild);
            
            while (logsContainer.children.length > 50) {
                logsContainer.removeChild(logsContainer.lastChild);
            }
        }
    </script>
</body>
</html>

