<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard V2 - Casa Inteligente</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
            overflow-x: auto;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-dot.connected {
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }
        .status-dot.disconnected {
            background: #f44336;
            box-shadow: 0 0 10px #f44336;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .house-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        .house-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            margin-bottom: 30px;
        }
        .room {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
            min-height: 300px;
            transition: all 0.3s;
        }
        .room:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        .room-title {
            font-size: 1.5em;
            font-weight: bold;
        }
        .room-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        .device {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .device:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
        }
        .device-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .device-name {
            font-size: 0.9em;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        .device-status {
            font-size: 0.85em;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        .device.on {
            border-color: #4caf50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }
        .device.on .device-status {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }
        .device.off {
            border-color: rgba(255, 255, 255, 0.2);
        }
        .device.off .device-status {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }
        .device.open {
            border-color: #2196F3;
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.3);
        }
        .device.open .device-status {
            background: rgba(33, 150, 243, 0.3);
            color: #2196F3;
        }
        .device.close {
            border-color: rgba(255, 255, 255, 0.2);
        }
        .device.close .device-status {
            background: rgba(255, 152, 0, 0.3);
            color: #ff9800;
        }
        .device.enabled {
            border-color: #f44336;
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.5);
            animation: alert-pulse 1s infinite;
        }
        .device.enabled .device-status {
            background: rgba(244, 67, 54, 0.5);
            color: #fff;
        }
        .device.disabled {
            border-color: rgba(255, 255, 255, 0.2);
        }
        .device.disabled .device-status {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }
        .device.temp {
            border-color: #ff9800;
        }
        .device.temp .device-status {
            background: rgba(255, 152, 0, 0.3);
            color: #ff9800;
        }
        .device.alert {
            border-color: #f44336;
            box-shadow: 0 0 20px rgba(244, 67, 54, 0.6);
            animation: alert-blink 1s infinite;
        }
        .device.alert .device-status {
            background: rgba(244, 67, 54, 0.5);
            color: #fff;
        }
        @keyframes alert-pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(244, 67, 54, 0.5); }
            50% { box-shadow: 0 0 25px rgba(244, 67, 54, 0.8); }
        }
        @keyframes alert-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .exterior {
            grid-column: 1 / -1;
            background: rgba(34, 139, 34, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.2);
        }
        .exterior .room-title::before {
            content: "üè° ";
        }
        .living .room-title::before {
            content: "üõãÔ∏è ";
        }
        .cocina .room-title::before {
            content: "üç≥ ";
        }
        .dormitorio .room-title::before {
            content: "üõèÔ∏è ";
        }
        .sensors-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }
        .sensors-panel h3 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        .sensors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .sensor-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .sensor-card h4 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .sensor-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .logs-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .logs-panel h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .log-entry {
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            border-left: 3px solid #4caf50;
        }
        .log-entry.error {
            border-left-color: #f44336;
        }
        .log-entry.warning {
            border-left-color: #ff9800;
        }
        .timestamp {
            color: #aaa;
            font-size: 0.8em;
            margin-right: 10px;
        }
        @media (max-width: 768px) {
            .house-layout {
                grid-template-columns: 1fr;
            }
            .exterior {
                grid-column: 1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè† Casa Inteligente - Vista Simulada</h1>
    </div>

    <div class="status-bar">
        <div class="status-indicator">
            <div id="statusDot" class="status-dot disconnected"></div>
            <span id="statusText">Desconectado</span>
        </div>
        <div id="messageCount">Mensajes recibidos: 0</div>
    </div>

    <div class="house-container">
        <!-- Layout de la Casa -->
        <div class="house-layout">
            <!-- Living -->
            <div class="room living">
                <div class="room-header">
                    <div class="room-title">Living</div>
                </div>
                <div class="room-content">
                    <div id="living-luz" class="device off">
                        <div class="device-icon">üí°</div>
                        <div class="device-name">Luz</div>
                        <div class="device-status">OFF</div>
                    </div>
                    <div id="tv" class="device off">
                        <div class="device-icon">üì∫</div>
                        <div class="device-name">TV</div>
                        <div class="device-status">OFF</div>
                    </div>
                    <div id="ventana" class="device close">
                        <div class="device-icon">ü™ü</div>
                        <div class="device-name">Ventana</div>
                        <div class="device-status">CERRADA</div>
                    </div>
                </div>
            </div>

            <!-- Cocina -->
            <div class="room cocina">
                <div class="room-header">
                    <div class="room-title">Cocina</div>
                </div>
                <div class="room-content">
                    <div id="cocina-luz" class="device off">
                        <div class="device-icon">üí°</div>
                        <div class="device-name">Luz</div>
                        <div class="device-status">OFF</div>
                    </div>
                    <div id="refrigerador" class="device temp">
                        <div class="device-icon">‚ùÑÔ∏è</div>
                        <div class="device-name">Refrigerador</div>
                        <div class="device-status">4¬∞C</div>
                    </div>
                </div>
            </div>

            <!-- Dormitorio -->
            <div class="room dormitorio">
                <div class="room-header">
                    <div class="room-title">Dormitorio</div>
                </div>
                <div class="room-content">
                    <div id="dormitorio-luz" class="device off">
                        <div class="device-icon">üí°</div>
                        <div class="device-name">Luz</div>
                        <div class="device-status">OFF</div>
                    </div>
                </div>
            </div>

            <!-- Exterior -->
            <div class="room exterior">
                <div class="room-header">
                    <div class="room-title">Exterior</div>
                </div>
                <div class="room-content">
                    <div id="puerta" class="device close">
                        <div class="device-icon">üö™</div>
                        <div class="device-name">Puerta Principal</div>
                        <div class="device-status">CERRADA</div>
                    </div>
                    <div id="alarma" class="device disabled">
                        <div class="device-icon">üö®</div>
                        <div class="device-name">Alarma</div>
                        <div class="device-status">DESACTIVADA</div>
                    </div>
                    <div id="temperatura" class="device temp">
                        <div class="device-icon">üå°Ô∏è</div>
                        <div class="device-name">Temperatura</div>
                        <div class="device-status">22¬∞C</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Sensores -->
        <div class="sensors-panel">
            <h3>üîç Sensores de Seguridad</h3>
            <div class="sensors-grid">
                <div id="humo" class="sensor-card">
                    <h4>üî• Sensor de Humo</h4>
                    <div class="sensor-value">Normal</div>
                </div>
                <div id="movimiento" class="sensor-card">
                    <h4>üë§ Sensor de Movimiento</h4>
                    <div class="sensor-value">Sin movimiento</div>
                </div>
                <div id="gas" class="sensor-card">
                    <h4>‚õΩ Sensor de Gas</h4>
                    <div class="sensor-value">Normal</div>
                </div>
            </div>
        </div>

        <!-- Logs -->
        <div class="logs-panel">
            <h3>üìù Logs en Tiempo Real</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        const client = mqtt.connect("wss://5fa060c50718458c97c7e3bd622628cd.s1.eu.hivemq.cloud:8884/mqtt", {
            username: "bemtorres",
            password: "Erensam18",
            clean: true,
            connectTimeout: 4000,
            reconnectPeriod: 1000
        });

        let mensajesRecibidos = 0;

        // Mapeo de topics a dispositivos
        const deviceMapping = {
            "hogar/living/luz/state": {
                elementId: "living-luz",
                update: (el, value) => {
                    const isOn = value === 'on';
                    el.className = `device ${isOn ? 'on' : 'off'}`;
                    el.querySelector('.device-status').textContent = isOn ? 'ON' : 'OFF';
                }
            },
            "hogar/living/luz/set": {
                elementId: "living-luz",
                update: (el, value) => {
                    const isOn = value === 'on';
                    el.className = `device ${isOn ? 'on' : 'off'}`;
                    el.querySelector('.device-status').textContent = isOn ? 'ON (cmd)' : 'OFF (cmd)';
                }
            },
            "hogar/cocina/luz/state": {
                elementId: "cocina-luz",
                update: (el, value) => {
                    const isOn = value === 'on';
                    el.className = `device ${isOn ? 'on' : 'off'}`;
                    el.querySelector('.device-status').textContent = isOn ? 'ON' : 'OFF';
                }
            },
            "hogar/cocina/luz/set": {
                elementId: "cocina-luz",
                update: (el, value) => {
                    const isOn = value === 'on';
                    el.className = `device ${isOn ? 'on' : 'off'}`;
                    el.querySelector('.device-status').textContent = isOn ? 'ON (cmd)' : 'OFF (cmd)';
                }
            },
            "hogar/dormitorio/luz/state": {
                elementId: "dormitorio-luz",
                update: (el, value) => {
                    const isOn = value === 'on';
                    el.className = `device ${isOn ? 'on' : 'off'}`;
                    el.querySelector('.device-status').textContent = isOn ? 'ON' : 'OFF';
                }
            },
            "hogar/dormitorio/luz/set": {
                elementId: "dormitorio-luz",
                update: (el, value) => {
                    const isOn = value === 'on';
                    el.className = `device ${isOn ? 'on' : 'off'}`;
                    el.querySelector('.device-status').textContent = isOn ? 'ON (cmd)' : 'OFF (cmd)';
                }
            },
            "hogar/puerta/principal/state": {
                elementId: "puerta",
                update: (el, value) => {
                    const isOpen = value === 'open';
                    el.className = `device ${isOpen ? 'open' : 'close'}`;
                    el.querySelector('.device-status').textContent = isOpen ? 'ABIERTA' : 'CERRADA';
                }
            },
            "hogar/puerta/principal/set": {
                elementId: "puerta",
                update: (el, value) => {
                    const isOpen = value === 'open';
                    el.className = `device ${isOpen ? 'open' : 'close'}`;
                    el.querySelector('.device-status').textContent = isOpen ? 'ABIERTA (cmd)' : 'CERRADA (cmd)';
                }
            },
            "hogar/alarma/state": {
                elementId: "alarma",
                update: (el, value) => {
                    const isEnabled = value === 'enabled' || value === 'activada';
                    el.className = `device ${isEnabled ? 'enabled' : 'disabled'}`;
                    el.querySelector('.device-status').textContent = isEnabled ? 'ACTIVADA' : 'DESACTIVADA';
                }
            },
            "hogar/alarma/set": {
                elementId: "alarma",
                update: (el, value) => {
                    const isEnabled = value === 'enabled' || value === 'activada';
                    el.className = `device ${isEnabled ? 'enabled' : 'disabled'}`;
                    el.querySelector('.device-status').textContent = isEnabled ? 'ACTIVADA (cmd)' : 'DESACTIVADA (cmd)';
                }
            },
            "hogar/clima/temperatura": {
                elementId: "temperatura",
                update: (el, value) => {
                    el.className = "device temp";
                    el.querySelector('.device-status').textContent = value + '¬∞C';
                }
            },
            "hogar/clima/temperatura/set": {
                elementId: "temperatura",
                update: (el, value) => {
                    el.className = "device temp";
                    el.querySelector('.device-status').textContent = value + '¬∞C (cmd)';
                }
            },
            "hogar/sensor/humo": {
                elementId: "humo",
                update: (el, value) => {
                    const isAlto = value === 'alto';
                    el.querySelector('.sensor-value').textContent = isAlto ? '‚ö†Ô∏è ALTO' : 'Normal';
                    el.querySelector('.sensor-value').style.color = isAlto ? '#f44336' : '#4caf50';
                    if (isAlto) {
                        el.style.border = '2px solid #f44336';
                        el.style.boxShadow = '0 0 15px rgba(244, 67, 54, 0.5)';
                    } else {
                        el.style.border = '2px solid rgba(255, 255, 255, 0.1)';
                        el.style.boxShadow = 'none';
                    }
                }
            },
            "hogar/sensor/movimiento": {
                elementId: "movimiento",
                update: (el, value) => {
                    const hayMovimiento = value === 'si' || value === 'yes';
                    el.querySelector('.sensor-value').textContent = hayMovimiento ? '‚úÖ Movimiento detectado' : 'Sin movimiento';
                    el.querySelector('.sensor-value').style.color = hayMovimiento ? '#4caf50' : '#aaa';
                }
            },
            "hogar/sensor/gas": {
                elementId: "gas",
                update: (el, value) => {
                    const isAlto = value === 'alto';
                    el.querySelector('.sensor-value').textContent = isAlto ? '‚ö†Ô∏è ALTO' : 'Normal';
                    el.querySelector('.sensor-value').style.color = isAlto ? '#f44336' : '#4caf50';
                    if (isAlto) {
                        el.style.border = '2px solid #f44336';
                        el.style.boxShadow = '0 0 15px rgba(244, 67, 54, 0.5)';
                    } else {
                        el.style.border = '2px solid rgba(255, 255, 255, 0.1)';
                        el.style.boxShadow = 'none';
                    }
                }
            },
            "hogar/living/tv/state": {
                elementId: "tv",
                update: (el, value) => {
                    const isOn = value === 'on';
                    el.className = `device ${isOn ? 'on' : 'off'}`;
                    el.querySelector('.device-status').textContent = isOn ? 'ON' : 'OFF';
                }
            },
            "hogar/living/tv/set": {
                elementId: "tv",
                update: (el, value) => {
                    const isOn = value === 'on';
                    el.className = `device ${isOn ? 'on' : 'off'}`;
                    el.querySelector('.device-status').textContent = isOn ? 'ON (cmd)' : 'OFF (cmd)';
                }
            },
            "hogar/living/ventana/state": {
                elementId: "ventana",
                update: (el, value) => {
                    const isOpen = value === 'open';
                    el.className = `device ${isOpen ? 'open' : 'close'}`;
                    el.querySelector('.device-status').textContent = isOpen ? 'ABIERTA' : 'CERRADA';
                }
            },
            "hogar/cocina/refrigerador/temperatura": {
                elementId: "refrigerador",
                update: (el, value) => {
                    el.className = "device temp";
                    el.querySelector('.device-status').textContent = value + '¬∞C';
                }
            }
        };

        client.on("connect", () => {
            console.log("‚úÖ Dashboard V2 conectado a MQTT!");
            document.getElementById("statusDot").className = "status-dot connected";
            document.getElementById("statusText").textContent = "‚úÖ Conectado";
            addLog("‚úÖ Conectado a MQTT", "success");
            
            // Suscribirse a todos los topics
            const topics = [
                "hogar/living/luz/state",
                "hogar/cocina/luz/state",
                "hogar/dormitorio/luz/state",
                "hogar/puerta/principal/state",
                "hogar/alarma/state",
                "hogar/clima/temperatura",
                "hogar/sensor/humo",
                "hogar/sensor/movimiento",
                "hogar/sensor/gas",
                "hogar/living/tv/state",
                "hogar/living/ventana/state",
                "hogar/cocina/refrigerador/temperatura",
                "hogar/living/luz/set",
                "hogar/cocina/luz/set",
                "hogar/dormitorio/luz/set",
                "hogar/puerta/principal/set",
                "hogar/alarma/set",
                "hogar/clima/temperatura/set",
                "hogar/living/tv/set"
            ];
            
            // Suscribirse con wildcards tambi√©n
            topics.forEach((topic, index) => {
                setTimeout(() => {
                    client.subscribe(topic, { qos: 1 }, (err) => {
                        if (!err) {
                            console.log(`‚úÖ Suscrito a: ${topic}`);
                        }
                    });
                }, index * 50);
            });
            
            // Wildcards
            setTimeout(() => {
                client.subscribe("hogar/#", { qos: 1 });
                client.subscribe("#", { qos: 1 });
            }, topics.length * 50 + 100);
        });

        client.on("error", (error) => {
            console.error("Error:", error);
            document.getElementById("statusDot").className = "status-dot disconnected";
            document.getElementById("statusText").textContent = "‚ùå Error de conexi√≥n";
            addLog("Error de conexi√≥n: " + error, "error");
        });

        client.on("offline", () => {
            document.getElementById("statusDot").className = "status-dot disconnected";
            document.getElementById("statusText").textContent = "‚ùå Desconectado";
            addLog("‚ö†Ô∏è Desconectado de MQTT", "warning");
        });

        client.on("reconnect", () => {
            document.getElementById("statusText").textContent = "üîÑ Reconectando...";
            addLog("üîÑ Intentando reconectar...", "warning");
        });

        client.on("message", (topic, message) => {
            const msg = message.toString();
            mensajesRecibidos++;
            document.getElementById("messageCount").textContent = `Mensajes recibidos: ${mensajesRecibidos}`;
            
            console.log(`üì® Mensaje #${mensajesRecibidos} recibido: ${topic} = ${msg}`);
            
            // Ignorar eventos de simulaci√≥n
            if (topic.includes('/evento/')) {
                return;
            }
            
            const mapping = deviceMapping[topic];
            if (mapping) {
                const element = document.getElementById(mapping.elementId);
                if (element) {
                    mapping.update(element, msg);
                    addLog(`${topic}: ${msg}`, "info");
                }
            } else {
                addLog(`${topic}: ${msg}`, "info");
            }
        });

        function addLog(message, type = 'info') {
            const logsContainer = document.getElementById("logs");
            const logEntry = document.createElement("div");
            logEntry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            
            logsContainer.insertBefore(logEntry, logsContainer.firstChild);
            
            // Limitar a 30 logs
            while (logsContainer.children.length > 30) {
                logsContainer.removeChild(logsContainer.lastChild);
            }
        }
    </script>
</body>
</html>


